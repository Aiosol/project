{% extends 'crm/base.html' %}
{% load static %}

{% block title %}Shipping Queue{% endblock %}

{% block page_title %}Shipping Queue{% endblock %}

{% block header_buttons %}
<button id="select-all-btn" class="btn btn-sm btn-outline-secondary me-2">
    <i class="fas fa-check-square"></i> Select All
</button>
<button id="ship-selected-btn" class="btn btn-sm btn-primary" disabled>
    <i class="fas fa-shipping-fast"></i> Ship Selected
</button>
<button id="refresh-status-btn" class="btn btn-sm btn-info ms-2">
    <i class="fas fa-sync-alt"></i> Refresh Statuses
</button>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Orders Ready for Shipping</h6>
        <div class="ml-2">
            <span id="selected-count" class="badge bg-primary">0 selected</span>
        </div>
    </div>
    <div class="card-body">
        <form id="bulk-ship-form" action="{% url 'crm:bulk_ship_orders' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="order_ids" id="selected-order-ids">
            
            <div class="table-responsive">
                <table class="table table-bordered" id="shippingTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all-orders">
                                </div>
                            </th>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Payment Method</th>
                            <th>Courier Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input order-checkbox" type="checkbox" value="{{ order.id }}">
                                </div>
                            </td>
                            <td>#{{ order.id }}</td>
                            <td>
                                {% if order.customer %}
                                    {{ order.customer.get_full_name|default:order.customer.username }}
                                {% else %}
                                    Guest
                                {% endif %}
                            </td>
                            <td>{{ order.created_at|date:"M d, Y H:i" }}</td>
                            <td>à§³{{ order.total_amount|floatformat:2 }}</td>
                            <td>{{ order.payment_method }}</td>
                            <td class="courier-status" data-order-id="{{ order.id }}">
                                {% if order.tracking_code %}
                                    <span class="badge {% if order.delivery_status == 'delivered' %}bg-success{% elif order.delivery_status == 'cancelled' %}bg-danger{% elif order.delivery_status == 'partly_delivered' %}bg-warning{% elif order.delivery_status == 'in_review' %}bg-info{% elif order.delivery_status == 'approval_pending' %}bg-secondary{% else %}bg-primary{% endif %}">
                                        {{ order.delivery_status|default:"pending"|title }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">Not Shipped</span>
                                {% endif %}
                                <a href="#" class="refresh-status-btn ms-2" data-order-id="{{ order.id }}" data-tracking-code="{{ order.tracking_code }}" title="Refresh Status">
                                    <i class="fas fa-sync-alt"></i>
                                </a>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'crm:order_detail' order.id %}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not order.tracking_code %}
                                    <a href="{% url 'crm:ship_order' order.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-shipping-fast"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">No orders ready for shipping</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<!-- Shipping Confirmation Modal -->
<div class="modal fade" id="shippingConfirmationModal" tabindex="-1" aria-labelledby="shippingConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shippingConfirmationModalLabel">Confirm Shipping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to ship <span id="ship-count">0</span> orders with Steadfast Courier?</p>
                <p>This will create shipping consignments for all selected orders and update their status.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-ship-btn">Ship Orders</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // DataTable initialization
        $('#shippingTable').DataTable({
            order: [[3, 'desc']]  // Sort by date
        });
        
        // Select all orders
        $('#select-all-orders').on('change', function() {
            $('.order-checkbox').prop('checked', $(this).prop('checked'));
            updateSelectionCount();
        });
        
        // Select all button (outside table)
        $('#select-all-btn').on('click', function() {
            const currentState = $('#select-all-orders').prop('checked');
            $('#select-all-orders').prop('checked', !currentState);
            $('.order-checkbox').prop('checked', !currentState);
            updateSelectionCount();
        });
        
        // Individual checkbox change
        $(document).on('change', '.order-checkbox', function() {
            updateSelectionCount();
            
            // Update select all checkbox state
            if ($('.order-checkbox:checked').length === $('.order-checkbox').length) {
                $('#select-all-orders').prop('checked', true);
            } else {
                $('#select-all-orders').prop('checked', false);
            }
        });
        
        // Ship selected button
        $('#ship-selected-btn').on('click', function() {
            const selectedCount = $('.order-checkbox:checked').length;
            $('#ship-count').text(selectedCount);
            $('#shippingConfirmationModal').modal('show');
        });
        
        // Confirm shipping
        $('#confirm-ship-btn').on('click', function() {
            const selectedIds = getSelectedOrderIds();
            console.log('Selected order IDs for shipping:', selectedIds);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one order to ship.');
                return;
            }
            
            $('#selected-order-ids').val(selectedIds.join(','));
            
            // Add a hidden field to indicate this is coming from the shipping queue
            if (!$('#from-queue-field').length) {
                $('#bulk-ship-form').append('<input type="hidden" id="from-queue-field" name="from_queue" value="true">');
            }
            
            // Submit the form
            $('#bulk-ship-form').submit();
        });
        
        // Update selection count and button state
        function updateSelectionCount() {
            const selectedCount = $('.order-checkbox:checked').length;
            $('#selected-count').text(selectedCount + ' selected');
            $('#ship-selected-btn').prop('disabled', selectedCount === 0);
        }
        
        // Get selected order IDs
        function getSelectedOrderIds() {
            return $('.order-checkbox:checked').map(function() {
                return $(this).val();
            }).get();
        }
        
        // Initialize selection count
        updateSelectionCount();
        
        // Individual refresh status buttons
        $('.refresh-status-btn').on('click', function(e) {
            e.preventDefault();
            const orderId = $(this).data('order-id');
            const trackingCode = $(this).data('tracking-code');
            
            if (!trackingCode) {
                alert('This order has not been shipped yet.');
                return;
            }
            
            refreshOrderStatus(orderId, trackingCode);
        });
        
        // Refresh all statuses button
        $('#refresh-status-btn').on('click', function() {
            refreshAllStatuses();
        });
        
        // Function to refresh a single order status
        function refreshOrderStatus(orderId, trackingCode) {
            if (!trackingCode) return;
            
            const statusCell = $(`.courier-status[data-order-id="${orderId}"]`);
            statusCell.html('<i class="fas fa-spinner fa-spin"></i> Updating...');
            
            $.ajax({
                url: '/crm/api/check-status/',
                type: 'POST',
                data: {
                    order_id: orderId,
                    tracking_code: trackingCode,
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        let badgeClass = 'bg-primary';
                        
                        // Determine badge color based on status
                        switch(response.status.toLowerCase()) {
                            case 'delivered':
                                badgeClass = 'bg-success';
                                break;
                            case 'cancelled':
                                badgeClass = 'bg-danger';
                                break;
                            case 'partly_delivered':
                            case 'partly delivered':
                                badgeClass = 'bg-warning';
                                break;
                            case 'in_review':
                                badgeClass = 'bg-info';
                                break;
                            case 'approval_pending':
                            case 'approval pending':
                                badgeClass = 'bg-secondary';
                                break;
                        }
                        
                        // Format the status text (replace underscores with spaces and capitalize)
                        const statusText = response.status
                            .replace(/_/g, ' ')
                            .replace(/\w\S*/g, function(txt) {
                                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                            });
                        
                        // Update the status cell
                        statusCell.html(`
                            <span class="badge ${badgeClass}">${statusText}</span>
                            <a href="#" class="refresh-status-btn ms-2" data-order-id="${orderId}" data-tracking-code="${trackingCode}" title="Refresh Status">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        `);
                        
                        // Re-bind the click event for the new refresh button
                        statusCell.find('.refresh-status-btn').on('click', function(e) {
                            e.preventDefault();
                            refreshOrderStatus(orderId, trackingCode);
                        });
                    } else {
                        statusCell.html(`
                            <span class="badge bg-danger">Error</span>
                            <a href="#" class="refresh-status-btn ms-2" data-order-id="${orderId}" data-tracking-code="${trackingCode}" title="Refresh Status">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        `);
                        console.error('Error refreshing status:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    statusCell.html(`
                        <span class="badge bg-danger">Error</span>
                        <a href="#" class="refresh-status-btn ms-2" data-order-id="${orderId}" data-tracking-code="${trackingCode}" title="Refresh Status">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                    `);
                    console.error('AJAX error:', error);
                }
            });
        }
        
        // Function to refresh all statuses
        function refreshAllStatuses() {
            $('.refresh-status-btn').each(function() {
                const orderId = $(this).data('order-id');
                const trackingCode = $(this).data('tracking-code');
                
                if (trackingCode) {
                    refreshOrderStatus(orderId, trackingCode);
                }
            });
        }
    });
</script>
{% endblock %}